app-id: io.openrct2.OpenRCT2
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: openrct2
rename-appdata-file: openrct2.appdata.xml
rename-desktop-file: openrct2.desktop
rename-icon: openrct2
copy-icon: true
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Pulseaudio access
  - --socket=pulseaudio
  # Network access - for multiplayer
  - --share=network
  # OpenGL access
  - --device=dri

modules:

  - name: innoextract
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/dscharrer/innoextract.git
        tag: '1.9'
        commit: 81fd9b95b76ee5115ce116bfdbc3bc6b887b809d
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
    modules:
      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=$FLATPAK_DEST --with-libraries=filesystem,iostreams,date_time,system,program_options
          - ./b2 -j$FLATPAK_BUILDER_N_JOBS install variant=release cxxstd=17 --layout=system
        sources:
          - type: archive
            url: https://boostorg.jfrog.io/artifactory/main/release/1.81.0/source/boost_1_81_0.tar.bz2
            sha256: 71feeed900fbccca04a3b4f2f84a7c217186f28a940ed8b7ed4725986baf99fa
            x-checker-data:
              type: html
              url: https://www.boost.org/feed/downloads.rss
              version-pattern: <link>https://www.boost.org/users/history/version_([\d_]+).html</link>
              url-template: https://boostorg.jfrog.io/artifactory/main/release/$version0.$version2.$version4/source/boost_$version.tar.bz2

  - name: OpenRCT2
    buildsystem: cmake
    builddir: true
    build-options:
      # See https://github.com/OpenRCT2/OpenRCT2/issues/17371
      cxxflags: -Wno-error=maybe-uninitialized -Wno-error=restrict -Wno-error=null-dereference
    config-opts:
      - -DDOWNLOAD_OBJECTS=OFF
      - -DDOWNLOAD_OPENSFX=OFF
      - -DDOWNLOAD_OPENMSX=OFF
      - -DDOWNLOAD_TITLE_SEQUENCES=OFF
    sources:
      - type: git
        url: https://github.com/OpenRCT2/OpenRCT2.git
        tag: v0.4.4
        commit: 9e4918cdbc3a90f3da0373fc824f675d9332d3f6
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: archive
        url: https://github.com/OpenRCT2/title-sequences/releases/download/v0.4.0/title-sequences.zip
        dest: data/sequence
        strip-components: 0
        sha256: 6e7c7b554717072bfc7acb96fd0101dc8e7f0ea0ea316367a05c2e92950c9029
        x-checker-data:
          type: json
          url: https://api.github.com/repos/OpenRCT2/title-sequences/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name=="title-sequences.zip") | .browser_download_url
      - type: archive
        url: https://github.com/OpenRCT2/objects/releases/download/v1.3.10/objects.zip
        dest: data/object
        strip-components: 0
        sha256: 9238ece6781a3f34e9adc3c3307a5db17fc988fbe5b3e90673f518ab455c0235
        x-checker-data:
          type: json
          url: https://api.github.com/repos/OpenRCT2/objects/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name=="objects.zip") | .browser_download_url
      - type: archive
        url: https://github.com/OpenRCT2/OpenSoundEffects/releases/download/v1.0.2/opensound.zip
        dest: data/assetpack/openrct2.sound.parkap
        strip-components: 0
        sha256: ab93e7d88190eec40b66cff84cacdb9fadc6b993fa769d4fd22ce9de98d5d22c
        x-checker-data:
          type: json
          url: https://api.github.com/repos/OpenRCT2/OpenSoundEffects/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name=="opensound.zip") | .browser_download_url
      - type: archive
        url: https://github.com/OpenRCT2/OpenMusic/releases/download/v1.1.0/openmusic.zip
        dest: data/assetpack/openrct2.music.alternative.parkap
        strip-components: 0
        sha256: e53e1b6c25deb81a2e1c19130d2935daa7a6741a45b46dbb58fd713135a98728
        x-checker-data:
          type: json
          url: https://api.github.com/repos/OpenRCT2/OpenMusic/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name=="openmusic.zip") | .browser_download_url
      - type: patch
        path: no-lstdcxxfs.patch
    post-install:
      - install ${FLATPAK_DEST}/share/applications/openrct2-savegame.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-savegame.desktop
      - install ${FLATPAK_DEST}/share/applications/openrct2-scenario.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-scenario.desktop
      - install ${FLATPAK_DEST}/share/applications/openrct2-uri.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-uri.desktop
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-savegame.desktop
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-scenario.desktop
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-uri.desktop
      - install ${FLATPAK_DEST}/share/mime/packages/openrct2.xml ${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}.xml
      - sed -i "s/<icon name=\"openrct2\"/<icon name=\"${FLATPAK_ID}\"/" ${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}.xml
    modules:

      - name: libzip
        buildsystem: cmake
        sources:
          - type: git
            url: https://github.com/nih-at/libzip.git
            tag: v1.9.2
            commit: 5532f9baa0c44cc5435ad135686a4ea009075b9a
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$

      - name: Nlohmann-JSON
        buildsystem: cmake-ninja
        config-opts:
          - -DJSON_BuildTests=OFF
          - -DJSON_MultipleHeaders=ON
          - -DJSON_SystemInclude=ON
        sources:
          - type: git
            url: https://github.com/nlohmann/json.git
            tag: v3.11.2
            commit: bc889afb4c5bf1c0d8ee29ef35eaaf4c8bef8a5d
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$

      - name: SpeexDSP
        buildsystem: autotools
        sources:
          - type: git
            url: https://github.com/xiph/speexdsp.git
            tag: SpeexDSP-1.2.1
            commit: 1b28a0f61bc31162979e1f26f3981fc3637095c8
            x-checker-data:
              type: git
              tag-pattern: ^SpeexDSP-([\d.]+)$

cleanup:
  - /bin/zip*
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/doc
  - /share/man
  - /share/cmake
  - '*.a'
  - '*.la'
