app-id: io.openrct2.OpenRCT2
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: openrct2
rename-appdata-file: openrct2.appdata.xml
rename-desktop-file: openrct2.desktop
rename-icon: openrct2
copy-icon: true
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Pulseaudio access
  - --socket=pulseaudio
  # Network access - for multiplayer
  - --share=network
  # OpenGL access
  - --device=dri
modules:

  - name: libzip
    buildsystem: cmake
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.8.0.tar.xz
        sha256: f0763bda24ba947e80430be787c4b068d8b6aa6027a26a19923f0acfa3dac97e

  - name: Nlohmann-JSON
    buildsystem: simple
    build-commands:
      - cp -r include/nlohmann ${CPLUS_INCLUDE_PATH}
    sources:
      - type: archive
        url: https://github.com/nlohmann/json/releases/download/v3.10.4/include.zip
        sha256: 62c585468054e2d8e7c2759c0d990fd339d13be988577699366fe195162d16cb
        strip-components: 0

  - name: SpeexDSP
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/xiph/speexdsp.git
        tag: SpeexDSP-1.2.0
        commit: 64cbfa9bca7479a758351aa02bb4abdd76baa9e7

  - name: Duktape
    buildsystem: simple
    build-commands:
      - make -f Makefile.sharedlibrary
      - make -f Makefile.sharedlibrary install
    sources:
      - type: archive
        url: https://duktape.org/duktape-2.6.0.tar.xz
        sha256: 96f4a05a6c84590e53b18c59bb776aaba80a205afbbd92b82be609ba7fe75fa7
      - type: patch
        path: duktape-installdir.patch

  - name: innoextract
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/dscharrer/innoextract/releases/download/1.9/innoextract-1.9.tar.gz
        sha256: 6344a69fc1ed847d4ed3e272e0da5998948c6b828cb7af39c6321aba6cf88126
    modules:
      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=/app --with-libraries=filesystem,iostreams,date_time,system,program_options
          - ./b2 -j$FLATPAK_BUILDER_N_JOBS install variant=release cxxstd=17 --layout=system
        sources:
          - type: archive
            url: https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2
            sha256: f0397ba6e982c4450f27bf32a2a83292aba035b827a5623a14636ea583318c41

  - name: OpenRCT2
    buildsystem: cmake
    builddir: true
    config-opts:
      - "-DCMAKE_BUILD_TYPE=RelWithDebInfo"
      - "-DDOWNLOAD_OBJECTS=OFF"
      - "-DDOWNLOAD_TITLE_SEQUENCES=OFF"
    sources:
      - type: git
        url: https://github.com/OpenRCT2/OpenRCT2.git
        tag: v0.3.5.1
        commit: 61c67afc667bfee8a6c3b180e98e84e87f442550
      - type: archive
        url: https://github.com/OpenRCT2/title-sequences/releases/download/v0.1.2c/title-sequences.zip
        dest: data/sequence
        strip-components: 0
        sha256: 5284333fa501270835b5f0cf420cb52155742335f5658d7889ea35d136b52517
      - type: archive
        url: https://github.com/OpenRCT2/objects/releases/download/v1.0.21/objects.zip
        dest: data/object
        strip-components: 0
        sha256: b081f885311f9afebc41d9dd4a68b7db4cf736eb815c04e307e1a426f08cfa35
      - type: patch
        path: no-lstdcxxfs.patch
    post-install:
      - "mv ${FLATPAK_DEST}/share/applications/openrct2-savegame.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-savegame.desktop"
      - "mv ${FLATPAK_DEST}/share/applications/openrct2-scenario.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-scenario.desktop"
      - "mv ${FLATPAK_DEST}/share/applications/openrct2-uri.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}-uri.desktop"
      - "mv ${FLATPAK_DEST}/share/mime/packages/openrct2.xml ${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}.xml"

cleanup:
  - /bin/zip*
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/doc
  - /share/man
  - /share/cmake
  - '*.a'
  - '*.la'
